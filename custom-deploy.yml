steps:
  - command: "--context dev.greens.systems set image deployment/log-cloudwatchlogger cloudwatchlogger=docker.io/australiangreens/docker-awslog:dev.${BUILDKITE_BUILD_NUMBER}"
    label: ":kubernetes: Deploy new image for the general cloudwatch logger to Dev"
    agents:
      queue: elastic
    plugins:
      docker-compose#v1.4.0:
        run: kubectl
        config: ${HOME}/greenkite/docker-compose.yml
    branches: '!master'

  - block: "Confirm deployment to :kubernetes: :red_button: "
    prompt: "Proceed with deployment to production?"
    branches: 'master'

  - wait

  - command: "--context prod.greens.systems set image deployment/greens-org-au-log-cloudwatchlogger cloudwatchlogger=docker.io/australiangreens/docker-awslog:${BUILDKITE_BUILD_NUMBER}"
    label: ":kubernetes: Deploy new image for the greens.org.au cloudwatch logger to Prod"
    agents:
      queue: elastic
    plugins:
      docker-compose#v1.4.0:
        run: kubectl
        config: ${HOME}/greenkite/docker-compose.yml
    branches: 'master'

  - command: "--context prod.greens.systems set image deployment/log-cloudwatchlogger cloudwatchlogger=docker.io/australiangreens/docker-awslog:${BUILDKITE_BUILD_NUMBER}"
    label: ":kubernetes: Deploy new image for the general cloudwatch logger to Prod"
    agents:
      queue: elastic
    plugins:
      docker-compose#v1.4.0:
        run: kubectl
        config: ${HOME}/greenkite/docker-compose.yml
    branches: 'master'
